name: ci-build

on:
    push:
        branches:
            - "*" # This will match all branches
        tags:
            - "*" # This will run only in all tags

jobs:
    build:
        strategy:
            matrix:
                docker_tag:
                    - centos8
                    - debian-buster
                    - debian-stretch
                    - fedora-latest
                    - fedora31
                    - opensuse-leap
                    - opensuse-tumbleweed
                    - ubuntults
                    - ubuntu1910
                os: [ubuntu-20.04]
                node: [12, 14]
            
        runs-on: ${{ matrix.os }}
        env: 
            DOCKER_TAG: ${{matrix.docker_tag}}
            FILE_EXTENSION: ""
            OS_TYPE: ""
        steps:
            - uses: actions/checkout@v2
            - name: Get file extension
              run: |
                if [[ $`echo ${{matrix.os}}` == "macos-latest" ]] ; then \
                    FILE_EXTENSION="pkg"
                    OS_TYPE="macos"
                elif [[ $`echo ${{matrix.os}}` == "windows-latest" ]] ; then \
                    FILE_EXTENSION="msi"
                    OS_TYPE="windows"
                else
                    OS_TYPE="${{matrix.os}}"
                    if [ $`echo ${{matrix.docker_tag}}` ==*"debian"* || $`echo ${{matrix.docker_tag}}`==*"ubuntu"* ] ; then \
                      FILE_EXTENSION="deb"
                    else
                      FILE_EXTENSION="rpm"
                    fi
                fi
            - if: matrix.os == 'ubuntu-20.04'
              run: |
                docker build --tag fortify-$DOCKER_TAG -f ./docker/Dockerfile.$DOCKER_TAG .
                docker run --name fortify-$DOCKER_TAG fortify-$DOCKER_TAG
                mkdir ./installers
                docker cp fortify-$DOCKER_TAG:/fortify/installer ./installers
            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
              with:
                tag_name: ${{ github.ref }}
                release_name: ${{ github.ref }}
                draft: false
                prerelease: false
            - name: Upload Release Asset
              id: upload-release-asset 
              uses: actions/upload-release-asset@v1
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
                asset_path: ./installers/fortify-$OS_TYPE.$FILE_EXTENSION
                asset_content_type: application/zip